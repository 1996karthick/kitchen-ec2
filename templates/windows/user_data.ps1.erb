<powershell>
  $logfile="C:\\Program Files\\Amazon\\Ec2ConfigService\\Logs\\kitchen-ec2.log"

  #PS Remoting and & winrm.cmd basic config
  Enable-PSRemoting -Force -SkipNetworkProfileCheck
  & winrm.cmd quickconfig -q >> $logfile
  & winrm.cmd set winrm/config '@{MaxTimeoutms="1800000"}' >> $logfile
  & winrm.cmd set winrm/config/winrs '@{MaxMemoryPerShellMB="512"}' >> $logfile
  & winrm.cmd set winrm/config/winrs '@{MaxShellsPerUser="50"}' >> $logfile

  #Client settings
  & winrm.cmd set winrm/config/client/auth '@{Basic="true"}' >> $logfile

  #Server settings
  & winrm.cmd set winrm/config/service/auth '@{Basic="true"}' >> $logfile
  & winrm.cmd set winrm/config/service '@{AllowUnencrypted="true"}' >> $logfile
  & winrm.cmd set winrm/config/winrs '@{MaxMemoryPerShellMB="1024"}' >> $logfile

  #Firewall Config
  & netsh.exe advfirewall set publicprofile state off  >> $logfile
  & netsh advfirewall firewall set rule name="Windows Remote Management (HTTP-In)" profile=public protocol=tcp localport=5985 remoteip=localsubnet new remoteip=any  >> $logfile

  <%= custom_admin_script %>

  <%= config[:user_data] %>

</powershell>
